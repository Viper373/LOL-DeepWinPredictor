name: Auto Release

on:
  push:
    branches:
      - main

jobs:
  always-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest tag
        id: get_tag
        run: |
          git fetch --tags
          latest_tag=$(git tag --list 'v*' --sort=-v:refname | head -n 1)
          if [ -z "$latest_tag" ]; then
            echo "tag=v1.0.0" >> $GITHUB_OUTPUT
          else
            IFS='.' read -r major minor patch <<<"${latest_tag#v}"
            if [[ -z "$minor" ]]; then minor=0; fi
            if [[ -z "$patch" ]]; then patch=0; fi
            if (( patch < 9 )); then
              patch=$((patch+1))
            else
              patch=0
              if (( minor < 9 )); then
                minor=$((minor+1))
              else
                minor=0
                major=$((major+1))
              fi
            fi
            echo "tag=v$major.$minor.$patch" >> $GITHUB_OUTPUT
          fi

      - name: Collect git diff
        id: diff
        run: |
          git log -1 --pretty=format:"%s%n%n%b" > commit_msg.txt
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            git diff HEAD^ HEAD > diff.txt
          else
            git show HEAD > diff.txt
          fi

      - name: Generate AI Release Notes
        id: ai_notes
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          # 构建 JSON 请求体并保存到临时文件
          cat << EOF > request.json
          {
            "model": "deepseek/deepseek-chat-v3-0324:free",
            "messages": [
              {
                "role": "user",
                "content": "请根据以下代码差异生成符合 GitHub Release 标准的 changelog，要求：\n1. 使用 ### 分类标题\n2. 每项添加合适 emoji\n3. 简明扼要描述变更\n\n代码差异：\n"
              }
            ]
          }
          EOF

          # 将 diff.txt 内容追加到 JSON 请求体末尾（转义双引号）
          echo -n '"' >> request.json
          cat diff.txt | sed 's/"/\\"/g' >> request.json
          echo '"' >> request.json
          echo '}' >> request.json

          # 调用 API（使用文件流避免参数超长）
          response=$(curl -s https://openrouter.ai/api/v1/chat/completions  \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENROUTER_API_KEY" \
            --data-binary @request.json)

          # 提取生成内容
          generated_notes=$(echo "$response" | jq -r '.choices[0].message.content')
          echo "generated_notes=$generated_notes" >> $GITHUB_ENV

      - name: Create tag and release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag ${{ steps.get_tag.outputs.tag }}
          git push origin ${{ steps.get_tag.outputs.tag }}
          # 使用 AI 生成的 Notes
          note="${{ env.generated_notes }}"
          gh release create ${{ steps.get_tag.outputs.tag }} --notes "$note" --title "${{ steps.get_tag.outputs.tag }}"